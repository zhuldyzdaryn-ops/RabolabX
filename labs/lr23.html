<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лаб. работа №23: Период и Амплитуда</title>
    <style>
        :root {
            --primary: #8e44ad; /* Фиолетовый из методички */
            --accent: #27ae60;
            --bg: #f4f6f7;
            --panel: #ffffff;
            --text: #2c3e50;
            --radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.3rem; }

        .lang-switch {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .lang-switch:hover { background: rgba(255,255,255,0.3); }

        /* --- MAIN LAYOUT --- */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 10px;
            gap: 15px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 380px;
            background: var(--panel);
            border-radius: var(--radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs { display: flex; background: #ecf0f1; }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: none;
            cursor: pointer; font-weight: 600; color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            background: #fff; color: var(--primary); border-bottom-color: var(--primary);
        }

        .tab-content { padding: 20px; overflow-y: auto; flex: 1; display: none; }
        .tab-content.active { display: block; }

        /* --- CONTROLS --- */
        .control-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary); }
        
        .val-display { float: right; font-weight: bold; color: var(--primary); }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white;
        }
        .btn-reset { background-color: #c0392b; }
        .btn-reset:hover { background-color: #a93226; }
        .btn-record { background-color: var(--accent); }
        .btn-record:hover { background-color: #219150; }

        .formula-box {
            background: #e8f6f3; border-left: 4px solid var(--accent);
            padding: 10px; margin: 10px 0; font-family: monospace; text-align: center;
        }

        /* --- SIMULATION --- */
        .sim-container {
            flex: 1;
            background: radial-gradient(circle at center, #ffffff, #e8eaeb);
            border-radius: var(--radius);
            border: 1px solid #dcdcdc;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        svg { width: 100%; height: 100%; cursor: default; }

        /* SVG Elements */
        .thread { stroke: #2c3e50; stroke-width: 2; }
        .ball { fill: url(#grad-ball); stroke: #2c3e50; stroke-width: 1; cursor: grab; }
        .ball:active { cursor: grabbing; }
        .pivot-bar { stroke: #7f8c8d; stroke-width: 6; stroke-linecap: round; }
        .sensor-line { stroke: #e74c3c; stroke-width: 1; stroke-dasharray: 4; opacity: 0.5; }
        
        /* Protractor */
        .protractor { fill: none; stroke: #bdc3c7; stroke-width: 1; }
        .protractor-text { fill: #95a5a6; font-size: 10px; text-anchor: middle; }

        /* Digital Display */
        .digital-display {
            position: absolute; top: 20px; right: 20px;
            background: #2c3e50; color: #f1c40f;
            padding: 15px; border-radius: 6px;
            font-family: 'Courier New', monospace;
            border: 2px solid #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            min-width: 160px;
        }
        .display-label { color: #bdc3c7; font-size: 0.8rem; display: block; }
        .display-val { font-size: 1.5rem; font-weight: bold; }
        .display-sub { font-size: 0.8rem; color: #fff; border-top: 1px solid #555; margin-top: 5px; padding-top: 5px;}

        /* Hint */
        .hint {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 8px 16px;
            border-radius: 20px; pointer-events: none; opacity: 1; font-size: 0.9rem; transition: opacity 0.5s;
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #f8f9fa; }

        .live-angle {
            position: absolute; top: 20px; left: 20px;
            font-weight: bold; color: var(--primary);
            background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 4px;
        }

    </style>
</head>
<body>

<header>
    <h1 id="lab-title">Лаб. №23: Период и Амплитуда</h1>
    <button class="lang-switch" onclick="toggleLang()">RU / KZ</button>
</header>

<div class="main-wrapper">
    
    <div class="sidebar">
        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('setup')" id="tab-setup">Установка</button>
            <button class="tab-btn" onclick="setTab('theory')" id="tab-theory">Теория</button>
            <button class="tab-btn" onclick="setTab('journal')" id="tab-journal">Журнал</button>
        </div>

        <div id="setup" class="tab-content active">
            <div class="control-group">
                <label id="lbl-len">Длина нити L (см): <span class="val-display" id="val-l">50</span></label>
                <input type="range" id="len-range" min="20" max="80" value="50" step="1" oninput="updateSettings()">
            </div>

            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 0.9rem; margin-bottom: 20px;">
                <strong id="lbl-instr">Инструкция:</strong>
                <ol style="padding-left: 20px; margin: 5px 0;">
                    <li id="instr-1">Установите длину нити L.</li>
                    <li id="instr-2">Отклоните шар на нужный угол (Амплитуда).</li>
                    <li id="instr-3">Отпустите шар. Таймер автоматически измерит период T.</li>
                    <li id="instr-4">Сравните периоды при малых и больших углах.</li>
                </ol>
            </div>
            
            <div class="formula-box">
                T_theor = <span id="val-t-theor">1.42</span> c
            </div>

            <button class="btn btn-record" onclick="recordData()" id="btn-record">ЗАПИСАТЬ РЕЗУЛЬТАТ</button>
            <button class="btn btn-reset" onclick="resetSim()" id="btn-reset">СБРОС / СТОП</button>
        </div>

        <div id="theory" class="tab-content">
            <h3 id="th-goal">Цель работы</h3>
            <p id="th-goal-text">Экспериментально подтвердить независимость периода колебания от амплитуды (для малых углов).</p>
            
            <h3 id="th-form">Формула периода</h3>
            <div class="formula-box">
                T = 2π√(L/g)
            </div>
            <p id="th-desc">
                Из формулы видно, что период зависит только от длины нити L и ускорения свободного падения g. От массы и амплитуды (при малых углах) период зависеть не должен.
            </p>
            <p id="th-note" style="color: #c0392b; font-size: 0.85rem;">
                *Примечание: При больших углах (>20°) период начинает незначительно расти из-за нарушения условия изохронности.
            </p>
        </div>

        <div id="journal" class="tab-content">
            <h3 id="th-journal">Результаты измерений</h3>
            <div style="overflow-x: auto;">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>L (см)</th>
                            <th>Amp (°)</th>
                            <th>T_exp (с)</th>
                            <th>T_theo (с)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-reset" onclick="clearTable()" style="margin-top: 10px; background: #95a5a6;">Очистить таблицу</button>
        </div>
    </div>

    <div class="sim-container">
        
        <div class="live-angle">
            <span id="angle-live">0</span>°
        </div>

        <div class="digital-display">
            <span class="display-label" id="disp-lbl">PERIOD (T):</span>
            <span class="display-val" id="disp-t">--.--</span> s
            <div class="display-sub">Cycles: <span id="disp-count">0</span></div>
        </div>

        <svg id="scene" viewBox="0 0 400 500" preserveAspectRatio="xMidYMax meet">
            <defs>
                <radialGradient id="grad-ball" cx="30%" cy="30%" r="70%">
                    <stop offset="0%" style="stop-color: #fff" />
                    <stop offset="100%" style="stop-color: #8e44ad" />
                </radialGradient>
            </defs>
            
            <g id="protractor-group" transform="translate(200, 20)"></g>

            <line x1="150" y1="20" x2="250" y2="20" class="pivot-bar" />

            <g id="pendulum">
                <line id="string" x1="0" y1="0" x2="0" y2="300" class="thread" />
                <circle id="ball" cx="0" cy="300" r="15" class="ball" />
            </g>

            <line x1="200" y1="50" x2="200" y2="450" class="sensor-line" />

        </svg>
        
        <div class="hint" id="hint-text">Отклоните шар на нужный угол</div>
    </div>
</div>

<script>
    // === CONFIGURATION ===
    const PIXELS_PER_METER = 500; 
    const PIVOT_X = 200;
    const PIVOT_Y = 20;
    const G = 9.81;

    // State
    let lengthM = 0.5; // meters
    let angle = 0; // radians
    let velocity = 0; // angular velocity
    let isDragging = false;
    let isRunning = false;
    
    // Measurement Logic
    let lastCrossTime = 0;
    let cycleCount = 0;
    let measuredPeriod = 0;
    let lastSign = 0;
    let initialAmp = 0;

    // DOM Elements
    const ui = {
        pendulum: document.getElementById('pendulum'),
        string: document.getElementById('string'),
        ball: document.getElementById('ball'),
        dispT: document.getElementById('disp-t'),
        dispCount: document.getElementById('disp-count'),
        valL: document.getElementById('val-l'),
        valTTheor: document.getElementById('val-t-theor'),
        angleLive: document.getElementById('angle-live'),
        hint: document.getElementById('hint-text'),
        svg: document.getElementById('scene'),
        protractor: document.getElementById('protractor-group')
    };

    // === INIT ===
    function init() {
        drawProtractor();
        updateSettings();
        ui.pendulum.setAttribute('transform', `translate(${PIVOT_X}, ${PIVOT_Y})`);
        renderPendulum();
    }

    function drawProtractor() {
        // Draw angles from -90 to 90
        const r = 250;
        for (let a = -90; a <= 90; a += 10) {
            const rad = a * Math.PI / 180;
            const x1 = Math.sin(rad) * (r - 10);
            const y1 = Math.cos(rad) * (r - 10);
            const x2 = Math.sin(rad) * r;
            const y2 = Math.cos(rad) * r;
            
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1); line.setAttribute("y1", y1);
            line.setAttribute("x2", x2); line.setAttribute("y2", y2);
            line.setAttribute("class", "protractor");
            ui.protractor.appendChild(line);

            if (a % 30 === 0) {
                const tx = Math.sin(rad) * (r + 15);
                const ty = Math.cos(rad) * (r + 15);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", tx); text.setAttribute("y", ty);
                text.setAttribute("class", "protractor-text");
                text.textContent = Math.abs(a) + "°";
                ui.protractor.appendChild(text);
            }
        }
    }

    // === TABS ===
    function setTab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    // === SETTINGS ===
    function updateSettings() {
        lengthM = parseFloat(document.getElementById('len-range').value) / 100;
        ui.valL.innerText = (lengthM * 100).toFixed(0);
        
        // Theoretical Period
        const T = 2 * Math.PI * Math.sqrt(lengthM / G);
        ui.valTTheor.innerText = T.toFixed(3);
        
        if (!isRunning && !isDragging) {
            angle = 0;
            velocity = 0;
            renderPendulum();
        }
    }

    // === SIMULATION LOOP ===
    function startSim() {
        if (isRunning) return;
        
        // Only start if there is an angle
        if (Math.abs(angle) < 0.05) return;

        isRunning = true;
        ui.hint.style.opacity = 0;
        
        initialAmp = Math.abs(angle * 180 / Math.PI);
        
        // Reset Counters
        cycleCount = 0;
        lastCrossTime = performance.now();
        measuredPeriod = 0;
        ui.dispT.innerText = "--.--";
        ui.dispCount.innerText = "0";
        lastSign = Math.sign(angle); // Detect zero crossing

        let lastTime = performance.now();

        function animate(time) {
            if (!isRunning && !isDragging) return;
            const dt = (time - lastTime) / 1000; 
            lastTime = time;

            if (!isDragging) {
                // Exact Non-Linear Physics: alpha'' = -(g/L)sin(alpha)
                const acc = -(G / lengthM) * Math.sin(angle);
                velocity += acc * dt;
                
                // Very slight damping
                velocity *= 0.9995; 
                
                angle += velocity * dt;

                // Period measurement logic
                // Detect crossing zero from same direction
                // Current approach: detect zero crossing. 2 crossings = 1 period.
                
                // Simple zero crossing check
                // We just passed zero if sign changed
                if (Math.sign(angle) !== lastSign && Math.abs(angle) < 0.2) {
                    // Just crossed zero
                    // We need full cycle.
                    // Let's count half cycles.
                    cycleCount += 0.5;
                    ui.dispCount.innerText = Math.floor(cycleCount);

                    if (cycleCount % 1 === 0 && cycleCount > 0) {
                        // Completed a full period
                        const now = performance.now();
                        const duration = (now - lastCrossTime) / 1000;
                        lastCrossTime = now;
                        measuredPeriod = duration;
                        ui.dispT.innerText = measuredPeriod.toFixed(3);
                    } else if (cycleCount === 0.5) {
                        // First half swing, reset timer base
                        lastCrossTime = performance.now();
                    }
                    
                    lastSign = Math.sign(angle) === 0 ? 1 : Math.sign(angle);
                }
            }

            renderPendulum();
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    }

    function renderPendulum() {
        const lenPx = lengthM * PIXELS_PER_METER;
        const x = lenPx * Math.sin(angle);
        const y = lenPx * Math.cos(angle);
        
        ui.string.setAttribute('x2', x);
        ui.string.setAttribute('y2', y);
        ui.ball.setAttribute('cx', x);
        ui.ball.setAttribute('cy', y);

        // Update angle display
        const deg = (angle * 180 / Math.PI).toFixed(0);
        ui.angleLive.innerText = Math.abs(deg);
    }

    function resetSim() {
        isRunning = false;
        angle = 0;
        velocity = 0;
        cycleCount = 0;
        ui.dispT.innerText = "--.--";
        ui.dispCount.innerText = "0";
        ui.hint.style.opacity = 1;
        renderPendulum();
    }

    // === DRAG & DROP ===
    ui.ball.addEventListener('mousedown', (e) => {
        isDragging = true;
        isRunning = false;
        velocity = 0;
        resetSimCounters();
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const pt = ui.svg.createSVGPoint();
        pt.x = e.clientX; pt.y = e.clientY;
        const svgP = pt.matrixTransform(ui.svg.getScreenCTM().inverse());
        
        const dx = svgP.x - PIVOT_X;
        const dy = svgP.y - PIVOT_Y;
        
        angle = Math.atan2(dx, dy);
        
        // Limit angle
        if (angle > 1.5) angle = 1.5;
        if (angle < -1.5) angle = -1.5;

        renderPendulum();
    });

    window.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            startSim();
        }
    });
    
    function resetSimCounters() {
        ui.dispT.innerText = "--.--";
        ui.dispCount.innerText = "0";
    }

    // === JOURNAL ===
    function recordData() {
        if (cycleCount < 1) return;
        
        const T_theo = 2 * Math.PI * Math.sqrt(lengthM / G);
        
        const tbody = document.querySelector('#data-table tbody');
        const row = document.createElement('tr');
        const n = tbody.children.length + 1;
        
        row.innerHTML = `
            <td>${n}</td>
            <td>${(lengthM*100).toFixed(0)}</td>
            <td>${initialAmp.toFixed(1)}</td>
            <td>${measuredPeriod.toFixed(3)}</td>
            <td>${T_theo.toFixed(3)}</td>
        `;
        tbody.appendChild(row);
    }

    function clearTable() {
        document.querySelector('#data-table tbody').innerHTML = '';
    }

    // === LOCALIZATION ===
    let currentLang = 'ru';
    const dict = {
        ru: {
            title: "Лаб. №23: Период и Амплитуда",
            tab1: "Установка", tab2: "Теория", tab3: "Журнал",
            lblL: "Длина нити L (см):",
            lblInstr: "Инструкция:",
            i1: "Установите длину нити L.",
            i2: "Отклоните шар на нужный угол (Амплитуда).",
            i3: "Отпустите шар. Таймер автоматически измерит период T.",
            i4: "Сравните периоды при малых и больших углах.",
            btnRec: "ЗАПИСАТЬ РЕЗУЛЬТАТ", btnRes: "СБРОС / СТОП",
            thGoal: "Цель работы", thGoalTx: "Экспериментально подтвердить независимость периода колебания от амплитуды (для малых углов).",
            thForm: "Формула периода",
            thDesc: "Из формулы видно, что период зависит только от длины нити L и ускорения свободного падения g.",
            thNote: "*Примечание: При больших углах (>20°) период начинает незначительно расти.",
            thJ: "Результаты измерений", hint: "Отклоните шар на нужный угол",
            dispLbl: "ПЕРИОД (T):", sub: "Колебаний:"
        },
        kz: {
            title: "Зертхана №23: Период және Амплитуда",
            tab1: "Қондырғы", tab2: "Теория", tab3: "Журнал",
            lblL: "Жіп ұзындығы L (см):",
            lblInstr: "Нұсқаулық:",
            i1: "Жіптің ұзындығын L орнатыңыз.",
            i2: "Шарды қажетті бұрышқа ауытқытыңыз (Амплитуда).",
            i3: "Шарды жіберіңіз. Таймер T периодын автоматты түрде өлшейді.",
            i4: "Кіші және үлкен бұрыштардағы периодтарды салыстырыңыз.",
            btnRec: "НӘТИЖЕНІ ЖАЗУ", btnRes: "ҚАЙТАРУ / ТОҚТАТУ",
            thGoal: "Жұмыс мақсаты", thGoalTx: "Тербеліс периодының амплитудаға тәуелсіздігін (кіші бұрыштар үшін) эксперимент жүзінде растау.",
            thForm: "Период формуласы",
            thDesc: "Формуладан периодтың тек жіп ұзындығына L және еркін түсу үдеуіне g тәуелді екені көрінеді.",
            thNote: "*Ескерту: Үлкен бұрыштарда (>20°) период шамалы өсе бастайды.",
            thJ: "Өлшеу нәтижелері", hint: "Шарды қажетті бұрышқа ауытқытыңыз",
            dispLbl: "ПЕРИОД (T):", sub: "Циклдар:"
        }
    };

    function toggleLang() {
        currentLang = currentLang === 'ru' ? 'kz' : 'ru';
        const t = dict[currentLang];
        document.getElementById('lab-title').innerText = t.title;
        document.getElementById('tab-setup').innerText = t.tab1;
        document.getElementById('tab-theory').innerText = t.tab2;
        document.getElementById('tab-journal').innerText = t.tab3;
        document.getElementById('lbl-len').childNodes[0].nodeValue = t.lblL + " ";
        document.getElementById('lbl-instr').innerText = t.lblInstr;
        document.getElementById('instr-1').innerText = t.i1;
        document.getElementById('instr-2').innerText = t.i2;
        document.getElementById('instr-3').innerText = t.i3;
        document.getElementById('instr-4').innerText = t.i4;
        document.getElementById('btn-record').innerText = t.btnRec;
        document.getElementById('btn-reset').innerText = t.btnRes;
        document.getElementById('th-goal').innerText = t.thGoal;
        document.getElementById('th-goal-text').innerText = t.thGoalTx;
        document.getElementById('th-form').innerText = t.thForm;
        document.getElementById('th-desc').innerText = t.thDesc;
        document.getElementById('th-note').innerText = t.thNote;
        document.getElementById('th-journal').innerText = t.thJ;
        document.getElementById('hint-text').innerText = t.hint;
        document.getElementById('disp-lbl').innerText = t.dispLbl;
        document.querySelector('.display-sub').childNodes[0].nodeValue = t.sub + " ";
    }

    init();

</script>
</body>
</html>