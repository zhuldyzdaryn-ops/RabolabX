<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Лаб. работа №7: Скорость и время</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #d35400; --bg: #fdfefe; --panel: #ffffff; --success: #27ae60; --text: #34495e; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* КНОПКА ПЕРЕКЛЮЧЕНИЯ ЯЗЫКА */
        .lang-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .lang-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
            margin-top: 30px;
        }

        .card { background: var(--panel); padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h1 { color: var(--primary); border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 0; font-size: 1.6rem; }
        p { margin-bottom: 15px; line-height: 1.5; }

        /* ФОРМУЛЫ */
        .formula-row { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; margin: 15px 0; }
        .formula-box { 
            background: #f8f9fa; padding: 15px; text-align: center; border-radius: 8px; 
            border: 1px solid #dfe6e9; min-width: 200px;
            font-family: 'Times New Roman', serif; font-size: 1.4rem; font-style: italic;
        }
        .fraction { display: inline-block; text-align: center; vertical-align: middle; margin: 0 4px; }
        .fraction-top { border-bottom: 1px solid #000; display: block; padding: 0 2px 2px 2px; }
        .fraction-bottom { display: block; padding: 2px 2px 0 2px; }

        /* УПРАВЛЕНИЕ */
        .control-group { margin-bottom: 20px; }
        label { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 8px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); }
        .val-display { color: var(--accent); font-weight: bold; font-family: monospace; font-size: 1.1em; }
        
        .stopwatch {
            background: #2c3e50; color: #f1c40f; font-family: 'Courier New', monospace; 
            font-size: 2.5rem; text-align: center; padding: 10px; border-radius: 6px; margin: 20px 0;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .btn { border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; margin-top: 8px; color: white; font-size: 1rem; }
        .btn-start { background: var(--success); }
        .btn-start:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-start:hover:not(:disabled) { background: #219150; }
        .btn-record { background: var(--accent); }
        .btn-record:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-reset { background: #95a5a6; }

        /* СИМУЛЯЦИЯ */
        .simulation-card { grid-column: 2; grid-row: 2 / 3; height: 500px; display: flex; flex-direction: column; }
        .svg-container { 
            flex-grow: 1; border: 1px solid #dfe6e9; background: #fff; border-radius: 8px; 
            position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        
        .rail { stroke: #bdc3c7; stroke-width: 12; stroke-linecap: round; }
        .rail-surface { stroke: #95a5a6; stroke-width: 2; }
        .cart-body { fill: #3498db; stroke: #2980b9; stroke-width: 2; }
        .cart-wheel { fill: #2c3e50; }
        .sensor { fill: #f39c12; stroke: #d35400; stroke-width: 1; } 
        .sensor-line { stroke: #e67e22; stroke-width: 1; stroke-dasharray: 4; opacity: 0.6; }
        .stand-pole { fill: #7f8c8d; stroke: #555; }
        .floor { stroke: #2c3e50; stroke-width: 2; }

        /* ТАБЛИЦА */
        .table-container { grid-column: 1 / -1; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #bdc3c7; padding: 10px; text-align: center; }
        th { background-color: #ecf0f1; }

        canvas { width: 100%; height: 450px; }
    </style>
</head>
<body>

<div class="lang-switch">
    <button class="lang-btn" onclick="toggleLang()">RU / KZ</button>
</div>

<div class="grid-container">

    <div class="card" style="grid-column: 1 / -1;">
        <h1 data-i18n="title">Лаб. работа №7: Зависимость скорости от времени</h1>
        <p data-i18n="goal">Цель: Определить зависимость мгновенной скорости от времени при равноускоренном движении.</p>
        <div class="formula-row">
            <div class="formula-box" style="background: #fff8e1; border-color: #f1c40f;">
                <div>v = <div class="fraction"><span class="fraction-top">2S</span><span class="fraction-bottom">t</span></div></div>
            </div>
            <div class="formula-box"><div>v = at</div></div>
            <div class="formula-box"><div>a = g &middot; sin(&alpha;)</div></div>
        </div>
    </div>

    <div class="card">
        <h2 data-i18n="settings">Настройки</h2>
        
        <div class="control-group">
            <label>
                <span data-i18n="h_lbl">Высота правого края (h):</span>
                <span class="val-display"><span id="h-val">15</span> см</span>
            </label>
            <input type="range" id="h-input" min="5" max="30" value="15" step="1" oninput="updateSetup()">
            <small style="color: #7f8c8d;" data-i18n="h_hint">Влияет на ускорение</small>
        </div>

        <div class="control-group">
            <label>
                <span data-i18n="s_lbl">Путь S (м):</span>
                <span class="val-display"><span id="s-val">0.40</span> м</span>
            </label>
            <input type="range" id="s-input" min="0.2" max="0.9" value="0.40" step="0.1" oninput="updateSetup()">
            <small style="color: #7f8c8d;" data-i18n="s_hint">Изменяйте S для новой точки</small>
        </div>
        
        <div class="stopwatch"><span id="timer-display">0.000</span></div>

        <button class="btn btn-start" id="btn-start" onclick="startSimulation()" data-i18n="btn_start">▶ ЗАПУСК</button>
        <button class="btn btn-record" id="btn-record" onclick="recordData()" disabled data-i18n="btn_record">⬇ ЗАПИСАТЬ (t1, t2, t3)</button>
        <button class="btn btn-reset" onclick="resetSim()" data-i18n="btn_reset">↺ СБРОС</button>
    </div>

    <div class="card simulation-card">
        <div class="svg-container">
            <svg id="sim-svg" viewBox="0 0 800 500" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 100%;">
                <defs>
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="1"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />

                <line x1="50" y1="450" x2="750" y2="450" class="floor" />

                <g id="bench-group" transform="translate(100, 450)">
                    <line x1="0" y1="0" x2="600" y2="0" class="rail" />
                    <line x1="0" y1="-6" x2="600" y2="-6" class="rail-surface" />
                    <g id="ruler-group"></g>

                    <g transform="translate(600, 0)">
                        <rect x="-5" y="-18" width="10" height="15" class="sensor" />
                        <text x="0" y="25" font-size="12" fill="#7f8c8d" text-anchor="middle">0</text>
                    </g>

                    <g id="sensor2-group">
                        <rect x="-5" y="-18" width="10" height="15" class="sensor" />
                        <line x1="0" y1="-18" x2="0" y2="-45" class="sensor-line" />
                        <text x="0" y="25" font-size="12" fill="#d35400" text-anchor="middle" font-weight="bold" id="sensor2-text">40см</text>
                    </g>

                    <g id="cart-group" transform="translate(600, 0)">
                        <rect x="-40" y="-35" width="80" height="24" class="cart-body" />
                        <circle cx="-25" cy="-6" r="6" class="cart-wheel" />
                        <circle cx="25" cy="-6" r="6" class="cart-wheel" />
                    </g>
                </g>
                
                <g id="stand-group" transform="translate(700, 0)">
                    <rect x="-5" y="350" width="10" height="100" class="stand-pole" id="stand-pole-rect" />
                    <rect x="-20" y="445" width="40" height="5" fill="#7f8c8d" />
                    <text x="15" y="400" font-size="14" fill="#7f8c8d" id="h-label" text-anchor="start">h</text>
                </g>

                <text x="150" y="440" font-size="14" fill="#7f8c8d">&alpha;</text>
                <path d="M 150,450 A 50,50 0 0 0 155,440" stroke="#bdc3c7" fill="none" id="angle-arc"/>
            </svg>
        </div>
        <div style="padding: 10px; background: #ecf0f1; border-top: 1px solid #ddd;">
            <strong data-i18n="status_lbl">Статус:</strong> <span id="status-text">Проведите 3 измерения для одной точки.</span>
        </div>
    </div>

    <div class="card table-container">
        <div style="display: flex; justify-content: space-between;">
            <h2 data-i18n="journal_title">Журнал (Усреднение 3-х опытов)</h2>
            <button class="btn" style="width: auto; background: #e74c3c; padding: 5px 15px;" onclick="clearTable()" data-i18n="btn_clear">Очистить</button>
        </div>
        <table id="data-table">
            <thead>
                <tr>
                    <th data-i18n="th_num">№</th>
                    <th data-i18n="th_s">Путь S (м)</th>
                    <th data-i18n="th_t1">t1 (с)</th>
                    <th data-i18n="th_t2">t2 (с)</th>
                    <th data-i18n="th_t3">t3 (с)</th>
                    <th data-i18n="th_tavg">t_ср (с)</th>
                    <th data-i18n="th_v">v = 2S/t_ср (м/с)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="charts-container">
        <div class="card">
            <h3 data-i18n="chart_title">График v(t)</h3>
            <div style="position: relative; height: 450px; width: 100%">
                <canvas id="chartVt"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    // === КОНСТАНТЫ И СОСТОЯНИЕ ===
    const g = 9.81;
    const PIXELS_PER_METER = 600;
    const RAIL_LENGTH_PX = 600;
    const PIVOT_X = 100;
    const PIVOT_Y = 450;
    const RAIL_START_LOCAL = 600; 

    let h_cm = 15;
    let S = 0.4;
    let measuredTime = 0;
    let currentAngleRad = 0;
    
    let trialCount = 0; 
    let lastRecordedS = -1;
    let currentRowId = null;

    let isRunning = false;
    let animFrame = null;
    let currentLang = 'ru';

    // === ЛОКАЛИЗАЦИЯ ===
    const i18n = {
        ru: {
            title: "Лаб. работа №7: Зависимость скорости от времени",
            goal: "Цель: Определить зависимость мгновенной скорости от времени при равноускоренном движении.",
            settings: "Настройки",
            h_lbl: "Высота правого края (h):",
            h_hint: "Влияет на ускорение",
            s_lbl: "Путь S (м):",
            s_hint: "Изменяйте S для новой точки",
            btn_start: "▶ ЗАПУСК",
            btn_record: "⬇ ЗАПИСАТЬ (t1, t2, t3)",
            btn_reset: "↺ СБРОС",
            status_lbl: "Статус:",
            journal_title: "Журнал (Усреднение 3-х опытов)",
            btn_clear: "Очистить",
            th_num: "№",
            th_s: "Путь S (м)",
            th_t1: "t1 (с)",
            th_t2: "t2 (с)",
            th_t3: "t3 (с)",
            th_tavg: "t_ср (с)",
            th_v: "v = 2S/t_ср (м/с)",
            chart_title: "График v(t)",
            chart_ds1: "Экспериментальные точки",
            chart_ds2: "Линия тренда (v = at)",
            chart_x: "Время t (с)",
            chart_y: "Скорость v (м/с)",
            stat_init: "Проведите 3 измерения для одной точки.",
            stat_ready_next: "<strong>Готово.</strong> Запишите измерение №{n} для S={s}м",
            stat_new_s_ready: "<strong>Готово.</strong> Это будет первое измерение для нового S={s}м",
            stat_done_series: "<strong>Серия завершена.</strong> Измените S.",
            stat_rec_t1: "Записано t1. Сделайте еще 2 запуска.",
            stat_rec_t2: "Записано t{n}. Сделайте следующий запуск.",
            stat_graph_added: "Серия завершена. Точка добавлена на график. Измените S.",
            alert_3_done: "Для этого расстояния уже сделано 3 измерения. Измените S!"
        },
        kz: {
            title: "№7 Зертханалық жұмыс: Жылдамдықтың уақытқа тәуелділігі",
            goal: "Мақсаты: Теңайнымалы қозғалыс кезіндегі лездік жылдамдықтың уақытқа тәуелділігін анықтау.",
            settings: "Параметрлер",
            h_lbl: "Оң жақ шетінің биіктігі (h):",
            h_hint: "Үдеуге әсер етеді",
            s_lbl: "Жол S (м):",
            s_hint: "Жаңа нүкте үшін S өзгертіңіз",
            btn_start: "▶ ІСКЕ ҚОСУ",
            btn_record: "⬇ ЖАЗУ (t1, t2, t3)",
            btn_reset: "↺ ҚАЙТАРУ",
            status_lbl: "Күйі:",
            journal_title: "Журнал (3 тәжірибенің орташа мәні)",
            btn_clear: "Тазалау",
            th_num: "№",
            th_s: "Жол S (м)",
            th_t1: "t1 (с)",
            th_t2: "t2 (с)",
            th_t3: "t3 (с)",
            th_tavg: "t_орт (с)",
            th_v: "v = 2S/t_орт (м/с)",
            chart_title: "v(t) графигі",
            chart_ds1: "Тәжірибелік нүктелер",
            chart_ds2: "Тренд сызығы (v = at)",
            chart_x: "Уақыт t (с)",
            chart_y: "Жылдамдық v (м/с)",
            stat_init: "Бір нүкте үшін 3 өлшеу жүргізіңіз.",
            stat_ready_next: "<strong>Дайын.</strong> S={s}м үшін №{n} өлшеуді жазыңыз",
            stat_new_s_ready: "<strong>Дайын.</strong> Бұл жаңа S={s}м үшін бірінші өлшеу болады",
            stat_done_series: "<strong>Серия аяқталды.</strong> S өзгертіңіз.",
            stat_rec_t1: "t1 жазылды. Тағы 2 рет іске қосыңыз.",
            stat_rec_t2: "t{n} жазылды. Келесі рет іске қосыңыз.",
            stat_graph_added: "Серия аяқталды. Нүкте графикке қосылды. S өзгертіңіз.",
            alert_3_done: "Бұл қашықтық үшін 3 өлшеу жасалды. S өзгертіңіз!"
        }
    };

    let lastStatusKey = 'stat_init';
    let lastStatusArgs = {};

    function setStatus(key, args = {}) {
        lastStatusKey = key;
        lastStatusArgs = args;
        updateStatusDisplay();
    }

    function updateStatusDisplay() {
        let text = i18n[currentLang][lastStatusKey];
        for (let k in lastStatusArgs) {
            text = text.replace('{'+k+'}', lastStatusArgs[k]);
        }
        document.getElementById('status-text').innerHTML = text;
    }

    function toggleLang() {
        currentLang = currentLang === 'ru' ? 'kz' : 'ru';
        
        // Обновляем статический текст
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
        });
        
        // Обновляем динамический текст статуса
        updateStatusDisplay();

        // Обновляем график
        updateChartLang();
    }

    function updateChartLang() {
        const d = i18n[currentLang];
        chartVt.data.datasets[0].label = d.chart_ds1;
        chartVt.data.datasets[1].label = d.chart_ds2;
        chartVt.options.scales.x.title.text = d.chart_x;
        chartVt.options.scales.y.title.text = d.chart_y;
        chartVt.update();
    }

    // UI элементы
    const ui = {
        hInput: document.getElementById('h-input'),
        sInput: document.getElementById('s-input'),
        hVal: document.getElementById('h-val'),
        sVal: document.getElementById('s-val'),
        timer: document.getElementById('timer-display'),
        
        benchGroup: document.getElementById('bench-group'),
        sensor2Group: document.getElementById('sensor2-group'),
        sensor2Text: document.getElementById('sensor2-text'),
        cartGroup: document.getElementById('cart-group'),
        rulerGroup: document.getElementById('ruler-group'),
        
        standGroup: document.getElementById('stand-group'),
        standPoleRect: document.getElementById('stand-pole-rect'),
        hLabel: document.getElementById('h-label'),
        angleArc: document.getElementById('angle-arc'),
        
        btnStart: document.getElementById('btn-start'),
        btnRecord: document.getElementById('btn-record'),
        tableBody: document.querySelector('#data-table tbody')
    };

    // Инициализация Chart.js
    const ctx = document.getElementById('chartVt').getContext('2d');
    const chartVt = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: [{
            label: i18n[currentLang].chart_ds1,
            data: [],
            backgroundColor: '#e67e22',
            pointRadius: 7
        },
        {
            label: i18n[currentLang].chart_ds2,
            data: [],
            showLine: true,
            borderColor: '#34495e',
            borderWidth: 2,
            pointRadius: 0,
            borderDash: [5, 5]
        }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: {display:true, text: i18n[currentLang].chart_x}, min: 0 },
                y: { title: {display:true, text: i18n[currentLang].chart_y}, min: 0 }
            }
        }
    });

    // === LOGIC ===

    function initRuler() {
        let svgHtml = '';
        for (let i = 0; i <= 10; i++) {
            const px = RAIL_START_LOCAL - (i * 0.1 * PIXELS_PER_METER);
            let h = 10;
            if (i % 5 === 0) h = 15;
            svgHtml += `<line x1="${px}" y1="0" x2="${px}" y2="${h}" stroke="#7f8c8d" stroke-width="1" />`;
            svgHtml += `<text x="${px}" y="${h+12}" font-size="10" fill="#7f8c8d" text-anchor="middle">${i*10}</text>`;
        }
        ui.rulerGroup.innerHTML = svgHtml;
    }

    function updateSetup() {
        if (isRunning) return;

        h_cm = parseInt(ui.hInput.value);
        S = parseFloat(ui.sInput.value);

        ui.hVal.innerText = h_cm;
        ui.sVal.innerText = S.toFixed(2);
        ui.sensor2Text.textContent = Math.round(S*100) + 'см';

        const sinA = h_cm / 100.0;
        currentAngleRad = Math.asin(sinA);
        const angleDeg = currentAngleRad * 180 / Math.PI;

        ui.benchGroup.setAttribute("transform", `translate(${PIVOT_X}, ${PIVOT_Y}) rotate(${-angleDeg})`);

        const railProjX = RAIL_LENGTH_PX * Math.cos(currentAngleRad);
        const standGlobalX = PIVOT_X + railProjX;
        ui.standGroup.setAttribute("transform", `translate(${standGlobalX}, 0)`);

        const liftPx = RAIL_LENGTH_PX * sinA;
        const standTopY = PIVOT_Y - liftPx;
        const poleHeight = 445 - standTopY;
        
        ui.standPoleRect.setAttribute("y", standTopY);
        ui.standPoleRect.setAttribute("height", poleHeight);
        ui.hLabel.setAttribute("y", standTopY + poleHeight/2);

        const arcX = PIVOT_X + 50 * Math.cos(-currentAngleRad);
        const arcY = PIVOT_Y + 50 * Math.sin(-currentAngleRad);
        ui.angleArc.setAttribute("d", `M ${PIVOT_X+50},${PIVOT_Y} A 50,50 0 0 0 ${arcX},${arcY}`);

        const sensorLocalX = RAIL_START_LOCAL - (S * PIXELS_PER_METER);
        ui.sensor2Group.setAttribute("transform", `translate(${sensorLocalX}, 0)`);

        ui.cartGroup.setAttribute("transform", `translate(${RAIL_START_LOCAL}, 0)`);

        ui.timer.innerText = "0.000";
        ui.btnRecord.disabled = true;
    }

    function startSimulation() {
        if (isRunning) return;
        isRunning = true;
        ui.btnStart.disabled = true;
        ui.btnRecord.disabled = true;
        
        ui.cartGroup.setAttribute("transform", `translate(${RAIL_START_LOCAL}, 0)`);

        const a_theor = g * Math.sin(currentAngleRad);
        const t_ideal = Math.sqrt((2 * S) / a_theor);
        
        const error = (Math.random() - 0.5) * 0.04;
        measuredTime = t_ideal + error;
        if(measuredTime < 0.05) measuredTime = t_ideal;

        let startTime = null;
        const duration = measuredTime * 1000;
        const distPx = S * PIXELS_PER_METER;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const t_curr = Math.min(elapsed / 1000, measuredTime);

            const a_vis = (2 * distPx) / (measuredTime * measuredTime);
            const deltaX = 0.5 * a_vis * t_curr * t_curr;

            const currentPos = RAIL_START_LOCAL - deltaX;
            ui.cartGroup.setAttribute("transform", `translate(${currentPos}, 0)`);
            ui.timer.innerText = t_curr.toFixed(3);

            if (elapsed < duration) {
                animFrame = requestAnimationFrame(animate);
            } else {
                finishRun();
            }
        }
        animFrame = requestAnimationFrame(animate);
    }

    function finishRun() {
        isRunning = false;
        ui.btnStart.disabled = false;
        ui.btnRecord.disabled = false;
        const finalPos = RAIL_START_LOCAL - (S * PIXELS_PER_METER);
        ui.cartGroup.setAttribute("transform", `translate(${finalPos}, 0)`);
        ui.timer.innerText = measuredTime.toFixed(3);
        
        if (Math.abs(S - lastRecordedS) < 0.001 && trialCount < 3) {
            setStatus('stat_ready_next', {n: trialCount + 1, s: S.toFixed(2)});
        } else if (Math.abs(S - lastRecordedS) >= 0.001) {
            setStatus('stat_new_s_ready', {s: S.toFixed(2)});
        } else {
            setStatus('stat_done_series');
        }
    }

    function resetSim() {
        if(animFrame) cancelAnimationFrame(animFrame);
        isRunning = false;
        ui.btnStart.disabled = false;
        updateSetup();
    }

    function recordData() {
        ui.btnRecord.disabled = true;
        const t = parseFloat(measuredTime.toFixed(3));
        
        if (Math.abs(S - lastRecordedS) > 0.001) {
            createNewRow(t);
        } else {
            if (trialCount < 3) {
                updateRow(t);
            } else {
                alert(i18n[currentLang].alert_3_done);
            }
        }
    }

    function createNewRow(t) {
        lastRecordedS = S;
        trialCount = 1;
        currentRowId = 'row-' + Date.now();
        
        const tbody = ui.tableBody;
        const row = document.createElement('tr');
        row.id = currentRowId;
        const num = tbody.children.length + 1;
        
        row.innerHTML = `
            <td>${num}</td>
            <td>${S.toFixed(2)}</td>
            <td id="t1-${currentRowId}">${t.toFixed(3)}</td>
            <td id="t2-${currentRowId}">-</td>
            <td id="t3-${currentRowId}">-</td>
            <td id="tavg-${currentRowId}">-</td>
            <td id="v-${currentRowId}">-</td>
        `;
        tbody.appendChild(row);
        setStatus('stat_rec_t1');
    }

    function updateRow(t) {
        trialCount++;
        document.getElementById(`t${trialCount}-${currentRowId}`).innerText = t.toFixed(3);
        
        if (trialCount === 3) {
            const t1 = parseFloat(document.getElementById(`t1-${currentRowId}`).innerText);
            const t2 = parseFloat(document.getElementById(`t2-${currentRowId}`).innerText);
            const t3 = t;
            
            const t_avg = (t1 + t2 + t3) / 3.0;
            const v = (2 * S) / t_avg;
            
            document.getElementById(`tavg-${currentRowId}`).innerText = t_avg.toFixed(3);
            document.getElementById(`v-${currentRowId}`).innerText = v.toFixed(2);
            
            addPointToGraph(t_avg, v);
            setStatus('stat_graph_added');
        } else {
            setStatus('stat_rec_t2', {n: trialCount});
        }
    }

    function addPointToGraph(t, v) {
        chartVt.data.datasets[0].data.push({x: t, y: v});
        
        const points = chartVt.data.datasets[0].data;
        const maxT = Math.max(...points.map(d => d.x));
        const a_avg = v/t; 
        
        chartVt.data.datasets[1].data = [
            {x: 0, y: 0},
            {x: maxT * 1.1, y: a_avg * maxT * 1.1}
        ];
        
        chartVt.update();
    }

    function clearTable() {
        ui.tableBody.innerHTML = '';
        chartVt.data.datasets[0].data = [];
        chartVt.data.datasets[1].data = [];
        chartVt.update();
        lastRecordedS = -1;
        trialCount = 0;
        setStatus('stat_init');
    }

    // Инициализация
    initRuler();
    updateSetup();
    setStatus('stat_init'); // Начальный статус

</script>
</body>
</html>