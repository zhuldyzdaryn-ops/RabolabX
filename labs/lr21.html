<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лаб. работа №21: Сохранение энергии</title>
    <style>
        :root {
            --primary: #27ae60;
            --accent: #2980b9;
            --bg: #f5f6fa;
            --panel: #ffffff;
            --text: #2c3e50;
            --radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.4rem; }

        .lang-switch {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .lang-switch:hover { background: rgba(255,255,255,0.3); }

        /* --- MAIN LAYOUT --- */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 10px;
            gap: 15px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 380px;
            background: var(--panel);
            border-radius: var(--radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs { display: flex; background: #dfe6e9; }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: none;
            cursor: pointer; font-weight: 600; color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            background: #fff; color: var(--primary); border-bottom-color: var(--primary);
        }

        .tab-content { padding: 20px; overflow-y: auto; flex: 1; display: none; }
        .tab-content.active { display: block; }

        /* --- THEORY & CONTROLS --- */
        .formula {
            background: #e8f5e9; border-left: 4px solid var(--primary);
            padding: 10px; margin: 10px 0; font-family: monospace; text-align: center;
        }
        
        .control-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="number"] { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white;
        }
        .btn-start { background-color: var(--primary); }
        .btn-start:hover { background-color: #219150; }
        .btn-reset { background-color: #e74c3c; }
        .btn-reset:hover { background-color: #c0392b; }
        .btn-record { background-color: var(--accent); }

        /* --- SIMULATION --- */
        .sim-container {
            flex: 1;
            background: radial-gradient(circle at center, #ffffff, #f1f2f6);
            border-radius: var(--radius);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid #dcdcdc;
        }

        svg { width: 100%; height: 100%; cursor: default; }

        /* SVG Elements */
        .rail { fill: #bdc3c7; stroke: #7f8c8d; stroke-width: 1; }
        .block { fill: #34495e; stroke: #2c3e50; }
        .magnet { fill: #e74c3c; }
        .sensor-box { fill: #f1c40f; stroke: #f39c12; stroke-width: 2; cursor: ns-resize; }
        .sensor-line { stroke: #e67e22; stroke-width: 2; stroke-dasharray: 4; }
        .ruler line { stroke: #95a5a6; stroke-width: 1; }
        .ruler text { fill: #7f8c8d; font-size: 10px; text-anchor: middle; }

        /* Digital Display */
        .digital-display {
            position: absolute; top: 20px; right: 20px;
            background: #2c3e50; color: #00ff00;
            padding: 15px; border-radius: 6px;
            font-family: 'Courier New', monospace;
            border: 2px solid #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .display-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 5px; }
        .display-label { color: #bdc3c7; font-size: 0.8rem; }

        /* Hint */
        .hint {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: white; padding: 8px 16px;
            border-radius: 20px; pointer-events: none; opacity: 1; font-size: 0.9rem;
        }

        /* Journal Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #f8f9fa; }
        
    </style>
</head>
<body>

<header>
    <h1 id="lab-title">Лаб. №21: Сохранение энергии</h1>
    <button class="lang-switch" onclick="toggleLang()">RU / KZ</button>
</header>

<div class="main-wrapper">
    
    <div class="sidebar">
        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('setup')" id="tab-setup">Установка</button>
            <button class="tab-btn" onclick="setTab('theory')" id="tab-theory">Теория</button>
            <button class="tab-btn" onclick="setTab('journal')" id="tab-journal">Журнал</button>
        </div>

        <div id="setup" class="tab-content active">
            <div class="control-group">
                <label id="lbl-mass">Масса груза m (г):</label>
                <input type="range" id="mass-range" min="50" max="200" value="100" step="10" oninput="updateSettings()">
                <div style="text-align: right; font-weight: bold; color: var(--primary)"><span id="mass-val">100</span> г</div>
            </div>

            <div class="control-group">
                <label id="lbl-h">Расстояние между датчиками &Delta;h:</label>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;" id="drag-hint">Перетащите нижний желтый датчик на схеме</div>
                <div style="text-align: right; font-weight: bold; color: var(--accent)"><span id="h-val">0.40</span> м</div>
            </div>

            <button class="btn btn-start" onclick="startSim()" id="btn-start">ПУСК (Свободное падение)</button>
            <button class="btn btn-reset" onclick="resetSim()" id="btn-reset">СБРОС</button>
            <button class="btn btn-record" onclick="recordData()" id="btn-record" style="margin-top: 10px;">Записать результат</button>
        </div>

        <div id="theory" class="tab-content">
            <h3 id="th-goal">Цель работы</h3>
            <p id="th-goal-text">Экспериментально проверить закон сохранения энергии на примере двух точек траектории при свободном падении.</p>
            
            <h3 id="th-law">Закон сохранения</h3>
            <div class="formula">
                E = E_k + E_p = const
            </div>
            <p id="th-desc">
                Для двух точек траектории (1 - верхняя, 2 - нижняя):
            </p>
            <div class="formula">
                mv₁²/2 + mg&Delta;h = mv₂²/2
            </div>
            <p id="th-method">
                Скорость определяется через время прохождения магнитом датчика (путь s = 2.5 см):
                <br> v = 0.025 / t
            </p>
        </div>

        <div id="journal" class="tab-content">
            <h3 id="th-journal">Результаты измерений</h3>
            <div style="overflow-x: auto;">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>t1 (c)</th>
                            <th>v1 (м/с)</th>
                            <th>t2 (c)</th>
                            <th>v2 (м/с)</th>
                            <th>&Delta;E_k (Дж)</th>
                            <th>&Delta;E_p (Дж)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top: 15px; font-size: 0.9rem; color: #555;">
                <strong id="lbl-compare">Сравнение:</strong> <span id="comparison-result">--</span>
            </div>
        </div>
    </div>

    <div class="sim-container">
        
        <div class="digital-display">
            <div class="display-row">
                <span class="display-label">GATE 1 (t1):</span>
                <span id="disp-t1">-.----</span> s
            </div>
            <div class="display-row">
                <span class="display-label">GATE 2 (t2):</span>
                <span id="disp-t2">-.----</span> s
            </div>
            <hr style="border-color: #444; margin: 5px 0;">
            <div class="display-row" style="color: #f1c40f;">
                <span class="display-label">&Delta;h:</span>
                <span id="disp-h">0.400</span> m
            </div>
        </div>

        <svg id="scene" viewBox="0 0 400 600" preserveAspectRatio="xMidYMid meet">
            <g id="ruler" transform="translate(80, 50)"></g>

            <rect x="180" y="50" width="40" height="500" class="rail" rx="5" />
            
            <g transform="translate(160, 100)">
                <rect x="0" y="-10" width="80" height="20" class="sensor-box" fill-opacity="0.8" style="cursor: default"/>
                <line x1="0" y1="0" x2="80" y2="0" class="sensor-line" />
                <text x="-10" y="5" font-size="12" text-anchor="end" fill="#f39c12" font-weight="bold">Gate 1</text>
            </g>

            <g id="sensor2" transform="translate(160, 300)" onmousedown="startDrag(evt)" ontouchstart="startDrag(evt)">
                <rect x="0" y="-10" width="80" height="20" class="sensor-box" />
                <line x1="0" y1="0" x2="80" y2="0" class="sensor-line" />
                <text x="-10" y="5" font-size="12" text-anchor="end" fill="#f39c12" font-weight="bold">Gate 2</text>
                <rect x="82" y="-5" width="4" height="10" fill="#333" />
            </g>

            <g id="block-group" transform="translate(190, 50)">
                <rect x="0" y="0" width="20" height="40" class="block" />
                <circle cx="10" cy="20" r="6" class="magnet" />
            </g>

            <line id="h-line" x1="250" y1="100" x2="250" y2="300" stroke="#2980b9" stroke-width="2" marker-end="url(#arrow)" marker-start="url(#arrow)" />
            <text id="h-text" x="260" y="200" fill="#2980b9" font-size="14" font-weight="bold">&Delta;h</text>
            
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <path d="M0,0 L0,10 L10,5 z" fill="#2980b9" />
                </marker>
            </defs>
        </svg>
        
        <div class="hint" id="hint-text">Настройте высоту и нажмите ПУСК</div>
    </div>
</div>

<script>
    // === CONFIGURATION ===
    const PIXELS_PER_METER = 500; 
    const SENSOR_Y_OFFSET = 50;   
    const SENSOR_WIDTH_M = 0.025; 
    const G = 9.81;

    // Fixed Position of Gate 1
    const GATE1_Y_PX = 100; 
    const START_Y_PX = 50;  

    // State
    let mass = 0.1; // kg
    let gate2Y_PX = 300; // Default pos
    let deltaH = 0; // meters
    let isRunning = false;
    let isDragging = false;
    let t1_val = 0, t2_val = 0; 
    
    // Переменные для хранения последних расчетов (для динамического перевода)
    let last_dEp = null;
    let last_dEk = null;
    let last_diffPercent = null;

    // DOM Elements
    const ui = {
        block: document.getElementById('block-group'),
        sensor2: document.getElementById('sensor2'),
        hLine: document.getElementById('h-line'),
        hText: document.getElementById('h-text'),
        dispT1: document.getElementById('disp-t1'),
        dispT2: document.getElementById('disp-t2'),
        dispH: document.getElementById('disp-h'),
        massVal: document.getElementById('mass-val'),
        hVal: document.getElementById('h-val'),
        hint: document.getElementById('hint-text'),
        svg: document.getElementById('scene')
    };

    // === INIT ===
    function init() {
        drawRuler();
        updateGeometry();
    }

    // === TABS ===
    function setTab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    // === SETTINGS ===
    function updateSettings() {
        mass = document.getElementById('mass-range').value / 1000;
        ui.massVal.innerText = (mass * 1000).toFixed(0);
    }

    function updateGeometry() {
        const pixelDist = gate2Y_PX - GATE1_Y_PX;
        deltaH = pixelDist / PIXELS_PER_METER;

        ui.sensor2.setAttribute('transform', `translate(160, ${gate2Y_PX})`);
        
        ui.hLine.setAttribute('y1', GATE1_Y_PX);
        ui.hLine.setAttribute('y2', gate2Y_PX);
        ui.hText.setAttribute('y', (GATE1_Y_PX + gate2Y_PX)/2);
        
        ui.hVal.innerText = deltaH.toFixed(3);
        ui.dispH.innerText = deltaH.toFixed(3);
    }

    // === SIMULATION ===
    function startSim() {
        if (isRunning) return;
        isRunning = true;
        ui.hint.style.opacity = 0;
        
        resetBlock();
        
        const y1_m = (GATE1_Y_PX - START_Y_PX) / PIXELS_PER_METER;
        const y2_m = (gate2Y_PX - START_Y_PX) / PIXELS_PER_METER;
        
        const v1_real = Math.sqrt(2 * G * y1_m);
        const v2_real = Math.sqrt(2 * G * y2_m);
        
        const t1_exact = (-v1_real + Math.sqrt(v1_real*v1_real + 2*G*SENSOR_WIDTH_M)) / G;
        const t2_exact = (-v2_real + Math.sqrt(v2_real*v2_real + 2*G*SENSOR_WIDTH_M)) / G;
        
        const noise = () => 1 + (Math.random() - 0.5) * 0.02;
        
        t1_val = t1_exact * noise();
        t2_val = t2_exact * noise();

        let startTime = null;
        const totalDistPx = gate2Y_PX + 50 - START_Y_PX; 
        const totalTimeS = Math.sqrt(2 * (totalDistPx/PIXELS_PER_METER) / G);
        const animDuration = totalTimeS * 1000; 

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const t_sim_s = elapsed / 1000;
            
            const currentY_m = 0.5 * G * t_sim_s * t_sim_s;
            const currentY_px = START_Y_PX + currentY_m * PIXELS_PER_METER;
            
            ui.block.setAttribute('transform', `translate(190, ${currentY_px})`);
            
            if (currentY_px >= GATE1_Y_PX && ui.dispT1.innerText === '-.----') {
                ui.dispT1.innerText = t1_val.toFixed(4);
            }
            if (currentY_px >= gate2Y_PX && ui.dispT2.innerText === '-.----') {
                ui.dispT2.innerText = t2_val.toFixed(4);
            }

            if (currentY_px < gate2Y_PX + 60) {
                requestAnimationFrame(animate);
            } else {
                isRunning = false;
            }
        }
        
        requestAnimationFrame(animate);
    }

    function resetBlock() {
        ui.block.setAttribute('transform', `translate(190, ${START_Y_PX})`);
        ui.dispT1.innerText = '-.----';
        ui.dispT2.innerText = '-.----';
    }

    function resetSim() {
        isRunning = false;
        resetBlock();
        ui.hint.style.opacity = 1;
    }

    // === DRAG & DROP ===
    function startDrag(evt) {
        if (isRunning) return;
        isDragging = true;
    }

    window.addEventListener('mousemove', (evt) => {
        if (!isDragging) return;
        moveSensor(evt.clientY);
    });

    window.addEventListener('touchmove', (evt) => {
        if (!isDragging) return;
        moveSensor(evt.touches[0].clientY);
    });

    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('touchend', () => isDragging = false);

    function moveSensor(clientY) {
        const pt = ui.svg.createSVGPoint();
        pt.x = 0; pt.y = clientY;
        const svgP = pt.matrixTransform(ui.svg.getScreenCTM().inverse());
        
        let newY = svgP.y;
        if (newY < 150) newY = 150;
        if (newY > 500) newY = 500;
        
        gate2Y_PX = newY;
        updateGeometry();
        resetBlock(); 
    }

    // === JOURNAL ===
    function recordData() {
        if (ui.dispT2.innerText === '-.----') return;
        
        const v1 = SENSOR_WIDTH_M / t1_val;
        const v2 = SENSOR_WIDTH_M / t2_val;
        
        const Ek1 = 0.5 * mass * v1 * v1;
        const Ek2 = 0.5 * mass * v2 * v2;
        const dEk = Ek2 - Ek1;
        
        const dEp = mass * G * deltaH;
        
        const tbody = document.querySelector('#data-table tbody');
        const row = document.createElement('tr');
        const n = tbody.children.length + 1;
        
        row.innerHTML = `
            <td>${n}</td>
            <td>${t1_val.toFixed(4)}</td>
            <td>${v1.toFixed(2)}</td>
            <td>${t2_val.toFixed(4)}</td>
            <td>${v2.toFixed(2)}</td>
            <td>${dEk.toFixed(3)}</td>
            <td>${dEp.toFixed(3)}</td>
        `;
        tbody.appendChild(row);

        // Сохраняем значения для возможности перевода "на лету"
        last_dEp = dEp;
        last_dEk = dEk;
        last_diffPercent = Math.abs((dEp - dEk)/dEp) * 100;
        
        updateComparisonText();
    }

    // Динамическое обновление текста сравнения энергий
    function updateComparisonText() {
        if (last_dEp === null) return; // Если еще ничего не измеряли
        
        const txt = currentLang === 'ru' ? 
            `Потеря Ep = ${last_dEp.toFixed(3)} Дж, Прирост Ek = ${last_dEk.toFixed(3)} Дж. Разница: ${last_diffPercent.toFixed(1)}%` :
            `Ep жоғалуы = ${last_dEp.toFixed(3)} Дж, Ek өсуі = ${last_dEk.toFixed(3)} Дж. Айырмашылық: ${last_diffPercent.toFixed(1)}%`;
        
        document.getElementById('comparison-result').innerText = txt;
        document.getElementById('comparison-result').style.color = last_diffPercent < 5 ? 'green' : 'red';
    }

    // === UTILS ===
    function drawRuler() {
        const g = document.getElementById('ruler');
        for(let i=0; i<=10; i++) {
            const y = i * 50;
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", -5); line.setAttribute("y1", y);
            line.setAttribute("x2", 5); line.setAttribute("y2", y);
            g.appendChild(line);
            
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", -15); text.setAttribute("y", y+3);
            text.textContent = (i*10);
            g.appendChild(text);
        }
    }

    // === LOCALIZATION ===
    let currentLang = 'ru';
    const dict = {
        ru: {
            title: "Лаб. №21: Сохранение энергии",
            tab1: "Установка", tab2: "Теория", tab3: "Журнал",
            lblM: "Масса груза m (г):", lblH: "Расстояние между датчиками \u0394h:",
            hintDrag: "Перетащите нижний желтый датчик на схеме",
            btnStart: "ПУСК (Свободное падение)", btnReset: "СБРОС", btnRec: "Записать результат",
            thGoal: "Цель работы", thGoalTx: "Экспериментально проверить закон сохранения энергии при свободном падении.",
            thLaw: "Закон сохранения", thDesc: "Изменение потенциальной энергии переходит в кинетическую:",
            thM: "Расчет скорости через датчик (S = 2.5 см):",
            tabJ: "Результаты измерений", lblComp: "Сравнение:",
            hint: "Настройте высоту и нажмите ПУСК"
        },
        kz: {
            title: "Зертхана №21: Энергияның сақталуы",
            tab1: "Қондырғы", tab2: "Теория", tab3: "Журнал",
            lblM: "Жүк массасы m (г):", lblH: "Датчиктер арасындағы қашықтық \u0394h:",
            hintDrag: "Сызбадағы төменгі сары датчикті жылжытыңыз",
            btnStart: "ІСКЕ ҚОСУ (Еркін түсу)", btnReset: "ҚАЙТАРУ", btnRec: "Нәтижені жазу",
            thGoal: "Жұмыс мақсаты", thGoalTx: "Еркін түсу кезіндегі энергияның сақталу заңын эксперимент жүзінде тексеру.",
            thLaw: "Сақталу заңы", thDesc: "Потенциалдық энергияның өзгеруі кинетикалық энергияға ауысады:",
            thM: "Датчик арқылы жылдамдықты есептеу (S = 2.5 см):",
            tabJ: "Өлшеу нәтижелері", lblComp: "Салыстыру:",
            hint: "Биіктікті реттеп, ІСКЕ ҚОСУ батырмасын басыңыз"
        }
    };

    function toggleLang() {
        currentLang = currentLang === 'ru' ? 'kz' : 'ru';
        const t = dict[currentLang];
        
        document.getElementById('lab-title').innerText = t.title;
        document.getElementById('tab-setup').innerText = t.tab1;
        document.getElementById('tab-theory').innerText = t.tab2;
        document.getElementById('tab-journal').innerText = t.tab3;
        document.getElementById('lbl-mass').innerText = t.lblM;
        document.getElementById('lbl-h').innerText = t.lblH;
        document.getElementById('drag-hint').innerText = t.hintDrag;
        document.getElementById('btn-start').innerText = t.btnStart;
        document.getElementById('btn-reset').innerText = t.btnReset;
        document.getElementById('btn-record').innerText = t.btnRec;
        document.getElementById('th-goal').innerText = t.thGoal;
        document.getElementById('th-goal-text').innerText = t.thGoalTx;
        document.getElementById('th-law').innerText = t.thLaw;
        document.getElementById('th-desc').innerText = t.thDesc;
        document.getElementById('th-method').innerHTML = t.thM + "<br> v = 0.025 / t";
        document.getElementById('th-journal').innerText = t.tabJ;
        document.getElementById('lbl-compare').innerText = t.lblComp;
        document.getElementById('hint-text').innerText = t.hint;

        // Обновляем текст расчета результатов под выбранный язык
        updateComparisonText();
    }

    init();

</script>
</body>
</html>