<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лаб. работа №15: Движение связанных тел</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #2980b9; 
            --bg: #fdfefe; 
            --panel: #ffffff; 
            --success: #27ae60; 
            --text: #34495e; 
            --border: #bdc3c7;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            overflow-y: auto; 
        }
        
        /* HEADER & LANG SWITCH */
        header {
            background-color: var(--primary);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .header-content h1 { margin: 0; font-size: 1.3rem; color: #fff; }
        .theory-mini { font-size: 0.85rem; opacity: 0.9; margin-top: 5px; }

        .lang-switch {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .lang-switch:hover { background: rgba(255,255,255,0.3); }

        /* FLEXBOX LAYOUT */
        .main-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            flex: 1;
            background: #ecf0f1;
            min-height: 650px;
        }

        .row-top {
            display: flex;
            gap: 20px;
            flex: 1.2;
            min-height: 0;
        }

        .row-bottom {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 250px;
        }

        .card { 
            background: var(--panel); 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            display: flex;
            flex-direction: column;
            border: 1px solid #dfe6e9;
        }
        
        h2, h3 { color: var(--primary); margin-top: 0; font-size: 1.1rem; margin-bottom: 12px; }

        /* 1. ПАНЕЛЬ УПРАВЛЕНИЯ */
        .controls-card { width: 340px; flex-shrink: 0; overflow-y: auto; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 12px; }
        .control-group:last-child { border: none; margin-bottom: 0; padding-bottom: 0; }
        label { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem;}
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); }
        .val-display { color: var(--accent); font-weight: bold; font-family: monospace; font-size: 1.1em; }
        
        .stopwatch {
            background: #2c3e50; color: #f1c40f; font-family: 'Courier New', monospace; 
            font-size: 2.2rem; text-align: center; padding: 10px; border-radius: 6px; margin: 15px 0;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .btn { border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; margin-top: 8px; color: white; font-size: 0.95rem; }
        .btn-start { background: var(--success); }
        .btn-start:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-start:hover:not(:disabled) { background: #219150; }
        .btn-record { background: var(--accent); }
        .btn-record:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-reset { background: #95a5a6; }

        /* 2. СИМУЛЯЦИЯ */
        .sim-card { flex: 1; padding: 0; overflow: hidden; }
        .svg-container { flex: 1; min-height: 0; display: flex; justify-content: center; align-items: flex-start; background: #fff;}
        
        /* SVG CSS */
        .rail-surface { stroke: #95a5a6; stroke-width: 2; }
        .cart-body { fill: #3498db; stroke: #2980b9; stroke-width: 2; }
        .cart-wheel { fill: #2c3e50; }
        .weight { fill: #e74c3c; stroke: #c0392b; stroke-width: 2; }
        .pulley { fill: #95a5a6; stroke: #7f8c8d; stroke-width: 2; }
        .string { stroke: #2c3e50; stroke-width: 2; fill: none; }
        .sensor { fill: #f1c40f; stroke: #f39c12; }

        /* 3. ЖУРНАЛ (НИЗ ЛЕВО) */
        .journal-card { flex: 1; padding: 0; overflow: hidden; }
        .j-header { padding: 15px; background: #f8f9fa; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;}
        .table-wrap { overflow-y: auto; flex: 1; padding: 0 15px 15px 15px;}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #bdc3c7; padding: 10px; text-align: center; }
        th { background-color: #ecf0f1; position: sticky; top: 0; }

        /* 4. ГРАФИК (НИЗ ПРАВО) */
        .chart-card { flex: 1; display: flex; flex-direction: column; }
        .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1 data-i18n="title">Лаб. работа №15: Движение связанных тел</h1>
        <div class="theory-mini">
            <span data-i18n="goal">Цель: Определить ускорение системы тел и сравнить экспериментальное значение с теоретическим.</span> |
            <b>a<sub>теор</sub> = mg / (M+m)</b> | 
            <b>a<sub>эксп</sub> = 2S / t²</b> |
            <b>ε = |a<sub>т</sub> - a<sub>э</sub>| / a<sub>т</sub> · 100%</b>
        </div>
    </div>
    <button class="lang-switch" onclick="toggleLang()">RU / KZ</button>
</header>

<div class="main-wrapper">
    
    <div class="row-top">
        <div class="card controls-card">
            <h2 data-i18n="h_settings">Установка параметров</h2>

            <div class="control-group">
                <label><span data-i18n="lbl_M">Масса тележки (M):</span> <span class="val-display"><span id="M-val">200</span> <span data-i18n="unit_g">г</span></span></label>
                <input type="range" id="M-input" min="100" max="500" value="200" step="50" oninput="updateSetup()">
            </div>

            <div class="control-group">
                <label><span data-i18n="lbl_m">Масса груза (m):</span> <span class="val-display"><span id="m-val">50</span> <span data-i18n="unit_g">г</span></span></label>
                <input type="range" id="m-input" min="10" max="100" value="50" step="10" oninput="updateSetup()">
            </div>

            <div class="control-group">
                <label><span data-i18n="lbl_s">Путь S (м):</span> <span class="val-display"><span id="s-val">0.50</span> <span data-i18n="unit_m">м</span></span></label>
                <input type="range" id="s-input" min="0.3" max="0.8" value="0.50" step="0.05" oninput="updateSetup()">
            </div>
            
            <div class="stopwatch"><span id="timer-display">0.000</span></div>

            <button class="btn btn-start" id="btn-start" onclick="startSimulation()" data-i18n="btn_start">▶ ЗАПУСК</button>
            <button class="btn btn-record" id="btn-record" onclick="recordData()" disabled data-i18n="btn_record">⬇ ЗАПИСАТЬ РЕЗУЛЬТАТ</button>
            <button class="btn btn-reset" onclick="resetSim()" data-i18n="btn_reset">↺ СБРОС</button>
        </div>

        <div class="card sim-card">
            <div class="svg-container">
                <svg id="sim-svg" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 100%;">
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />

                    <rect x="50" y="250" width="600" height="20" fill="#ecf0f1" stroke="#bdc3c7" />
                    <line x1="50" y1="250" x2="650" y2="250" class="rail-surface" />

                    <g id="ruler-group" transform="translate(50, 250)"></g>

                    <circle cx="660" cy="240" r="15" class="pulley" />
                    <circle cx="660" cy="240" r="2" fill="#333" />

                    <rect x="100" y="235" width="5" height="15" class="sensor" /> 
                    <text x="100" y="280" font-size="12" fill="#7f8c8d" text-anchor="middle">0</text>

                    <g id="sensor2-group" transform="translate(450, 0)">
                        <rect x="100" y="235" width="5" height="15" class="sensor" />
                        <text x="100" y="280" font-size="12" fill="#d35400" text-anchor="middle" font-weight="bold" id="sensor2-text">50см</text>
                    </g>

                    <g id="cart-body-group" transform="translate(100, 225)">
                         <rect x="-40" y="-15" width="80" height="30" class="cart-body" rx="4" />
                        <text x="0" y="5" font-size="12" fill="white" text-anchor="middle" id="cart-mass-text">M</text>
                        <circle cx="-25" cy="15" r="8" class="cart-wheel" />
                        <circle cx="25" cy="15" r="8" class="cart-wheel" />
                    </g>

                    <g id="weight-group" transform="translate(675, 240)">
                        <line x1="0" y1="0" x2="0" y2="50" class="string" id="vertical-string"/>
                        <rect x="-10" y="50" width="20" height="25" class="weight" rx="2" />
                        <text x="0" y="67" font-size="10" fill="white" text-anchor="middle" id="load-mass-text">m</text>
                    </g>

                    <line x1="140" y1="225" x2="660" y2="225" class="string" id="horiz-string" />
                    <path d="M 660,225 A 15,15 0 0 1 675,240" class="string" fill="none" />

                </svg>
            </div>
            <div style="padding: 10px 20px; background: #f8f9fa; border-top: 1px solid #ddd; font-size:0.95rem;">
                <strong data-i18n="stat_lbl">Статус:</strong> <span id="status-text">Задайте массы M и m.</span>
            </div>
        </div>
    </div>

    <div class="row-bottom">
        <div class="card journal-card">
            <div class="j-header">
                <span data-i18n="j_title">Журнал измерений</span>
                <button class="btn btn-reset" style="width: auto; padding: 6px 15px; margin:0;" onclick="clearTable()" data-i18n="btn_clear">Очистить</button>
            </div>
            <div class="table-wrap">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="th_num">№</th>
                            <th data-i18n="th_M">M (г)</th>
                            <th data-i18n="th_m">m (г)</th>
                            <th data-i18n="th_s">S (м)</th>
                            <th data-i18n="th_t">t (с)</th>
                            <th data-i18n="th_a_exp">a_эксп (м/с²)</th>
                            <th data-i18n="th_a_theor">a_теор (м/с²)</th>
                            <th data-i18n="th_err">Погр. (%)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card chart-card">
            <h3 data-i18n="chart_title" style="margin-bottom: 10px;">Зависимость пути от квадрата времени S(t²)</h3>
            <div class="chart-container">
                <canvas id="chartSt"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    // === КОНСТАНТЫ ===
    const g = 9.81;
    const PIXELS_PER_METER = 700; // Масштаб
    const START_X = 100; // Позиция старта тележки (центр)
    const PULLEY_X = 660; // Центр блока
    
    // Состояние
    let MassCart = 200; // грамм
    let MassLoad = 50;  // грамм
    let S = 0.50;       // метры
    
    let measuredTime = 0;
    let a_exp = 0;
    let a_theor = 0;

    let isRunning = false;
    let animFrame = null;
    let currentLang = 'ru';

    // === ЛОКАЛИЗАЦИЯ ===
    const i18n = {
        ru: {
            title: "Лаб. работа №15: Движение связанных тел",
            goal: "Цель: Определить ускорение системы тел и сравнить экспериментальное значение с теоретическим.",
            h_settings: "Установка параметров",
            lbl_M: "Масса тележки (M):",
            lbl_m: "Масса груза (m):",
            lbl_s: "Путь S (м):",
            unit_g: "г",
            unit_m: "м",
            btn_start: "▶ ЗАПУСК",
            btn_record: "⬇ ЗАПИСАТЬ РЕЗУЛЬТАТ",
            btn_reset: "↺ СБРОС",
            stat_lbl: "Статус:",
            stat_init: "Задайте массы M и m.",
            stat_move: "Движение...",
            stat_finish: "Финиш. Запишите данные.",
            stat_rec: "Данные записаны. Измените параметры.",
            j_title: "Журнал измерений",
            btn_clear: "Очистить",
            th_num: "№",
            th_M: "M (г)",
            th_m: "m (г)",
            th_s: "S (м)",
            th_t: "t (с)",
            th_a_exp: "a_эксп (м/с²)",
            th_a_theor: "a_теор (м/с²)",
            th_err: "Погр. (%)",
            chart_title: "Зависимость пути от квадрата времени S(t²)",
            chart_ds_exp: "Эксперимент S(t²)",
            chart_ds_theor: "Теория (линия)",
            chart_x: "t² (с²)",
            chart_y: "Путь S (м)"
        },
        kz: {
            title: "№15 Зертханалық жұмыс: Байланысқан денелердің қозғалысы",
            goal: "Мақсаты: Денелер жүйесінің үдеуін анықтау және тәжірибелік мәнді теориялық мәнмен салыстыру.",
            h_settings: "Параметрлерді орнату",
            lbl_M: "Арбашаның массасы (M):",
            lbl_m: "Жүктің массасы (m):",
            lbl_s: "Жол S (м):",
            unit_g: "г",
            unit_m: "м",
            btn_start: "▶ ІСКЕ ҚОСУ",
            btn_record: "⬇ НӘТИЖЕНІ ЖАЗУ",
            btn_reset: "↺ ҚАЙТАРУ",
            stat_lbl: "Күйі:",
            stat_init: "M және m массаларын орнатыңыз.",
            stat_move: "Қозғалыс...",
            stat_finish: "Мәре. Деректерді жазыңыз.",
            stat_rec: "Деректер жазылды. Параметрлерді өзгертіңіз.",
            j_title: "Өлшеу журналы",
            btn_clear: "Тазалау",
            th_num: "№",
            th_M: "M (г)",
            th_m: "m (г)",
            th_s: "S (м)",
            th_t: "t (с)",
            th_a_exp: "a_тәж (м/с²)",
            th_a_theor: "a_теор (м/с²)",
            th_err: "Қателік (%)",
            chart_title: "Жолдың уақыт квадратына тәуелділігі S(t²)",
            chart_ds_exp: "Тәжірибе S(t²)",
            chart_ds_theor: "Теория (сызық)",
            chart_x: "t² (с²)",
            chart_y: "Жол S (м)"
        }
    };

    let currentStateLabel = 'stat_init';

    function toggleLang() {
        currentLang = currentLang === 'ru' ? 'kz' : 'ru';
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[currentLang][key]) {
                el.innerText = i18n[currentLang][key];
            }
        });

        updateStateText(currentStateLabel);
        updateChartLang();
    }

    function updateStateText(stateKey) {
        currentStateLabel = stateKey;
        document.getElementById('status-text').innerText = i18n[currentLang][stateKey];
    }

    // UI
    const ui = {
        MInput: document.getElementById('M-input'),
        mInput: document.getElementById('m-input'),
        sInput: document.getElementById('s-input'),
        MVal: document.getElementById('M-val'),
        mVal: document.getElementById('m-val'),
        sVal: document.getElementById('s-val'),
        timer: document.getElementById('timer-display'),
        status: document.getElementById('status-text'),
        
        sensor2Group: document.getElementById('sensor2-group'),
        sensor2Text: document.getElementById('sensor2-text'),
        
        cartBodyGroup: document.getElementById('cart-body-group'),
        weightGroup: document.getElementById('weight-group'),
        horizString: document.getElementById('horiz-string'),
        verticalString: document.getElementById('vertical-string'),
        cartMassText: document.getElementById('cart-mass-text'),
        loadMassText: document.getElementById('load-mass-text'),
        rulerGroup: document.getElementById('ruler-group'),

        btnStart: document.getElementById('btn-start'),
        btnRecord: document.getElementById('btn-record'),
        tableBody: document.querySelector('#data-table tbody')
    };

    // Chart.js
    const ctx = document.getElementById('chartSt').getContext('2d');
    const chartSt = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: [{
            label: i18n[currentLang].chart_ds_exp,
            data: [],
            backgroundColor: '#2980b9',
            pointRadius: 6
        }, {
            label: i18n[currentLang].chart_ds_theor,
            data: [],
            type: 'line',
            borderColor: '#e74c3c',
            borderDash: [5, 5],
            pointRadius: 0
        }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: {display:true, text: i18n[currentLang].chart_x}, min: 0 },
                y: { title: {display:true, text: i18n[currentLang].chart_y}, min: 0 }
            }
        }
    });

    function updateChartLang() {
        chartSt.data.datasets[0].label = i18n[currentLang].chart_ds_exp;
        chartSt.data.datasets[1].label = i18n[currentLang].chart_ds_theor;
        chartSt.options.scales.x.title.text = i18n[currentLang].chart_x;
        chartSt.options.scales.y.title.text = i18n[currentLang].chart_y;
        chartSt.update();
    }

    // === LOGIC ===

    function initRuler() {
        let svgHtml = '';
        for (let i = 0; i <= 6; i++) {
            const px = 50 + i * 0.1 * PIXELS_PER_METER; 
            let h = 10;
            if (i % 5 === 0) h = 15;
            svgHtml += `<line x1="${px}" y1="0" x2="${px}" y2="${h}" stroke="#95a5a6" stroke-width="1" />`;
            svgHtml += `<text x="${px}" y="${h+12}" font-size="10" fill="#7f8c8d" text-anchor="middle">${i*10}</text>`;
        }
        ui.rulerGroup.innerHTML = svgHtml;
    }

    function updateSetup() {
        if (isRunning) return;

        MassCart = parseInt(ui.MInput.value);
        MassLoad = parseInt(ui.mInput.value);
        S = parseFloat(ui.sInput.value);

        ui.MVal.innerText = MassCart;
        ui.mVal.innerText = MassLoad;
        ui.sVal.innerText = S.toFixed(2);
        
        ui.cartMassText.textContent = MassCart;
        ui.loadMassText.textContent = MassLoad;
        ui.sensor2Text.textContent = Math.round(S*100) + 'см';

        const sPx = S * PIXELS_PER_METER;
        ui.sensor2Group.setAttribute("transform", `translate(${sPx}, 0)`);

        setCartPosition(0);

        ui.timer.innerText = "0.000";
        updateStateText('stat_init');
        ui.btnRecord.disabled = true;
    }

    function setCartPosition(xOffset) {
        const currentCartX = START_X + xOffset;
        ui.cartBodyGroup.setAttribute("transform", `translate(${currentCartX}, 225)`);
        
        ui.horizString.setAttribute("x1", currentCartX + 40);
        ui.horizString.setAttribute("x2", PULLEY_X); 

        const startLoadY = 240; 
        const currentLoadY = startLoadY + xOffset; 
        
        ui.weightGroup.setAttribute("transform", `translate(675, ${currentLoadY})`);
        
        const stringLen = xOffset; 
        ui.verticalString.setAttribute("y1", -stringLen);
        ui.verticalString.setAttribute("y2", 50); 
    }

    function startSimulation() {
        if (isRunning) return;
        isRunning = true;
        ui.btnStart.disabled = true;
        ui.btnRecord.disabled = true;

        const M_kg = MassCart / 1000;
        const m_kg = MassLoad / 1000;
        
        const a = (m_kg * g) / (M_kg + m_kg);
        
        const frictionCoeff = 0.02; 
        const a_real = a - (frictionCoeff * g);
        
        const t_ideal = Math.sqrt((2 * S) / a_real);
        
        const error = (Math.random() - 0.5) * 0.05;
        measuredTime = t_ideal + error;
        
        a_theor = a;
        a_exp = (2 * S) / (measuredTime * measuredTime);

        let startTime = null;
        const duration = measuredTime * 1000;
        const distPx = S * PIXELS_PER_METER;

        updateStateText('stat_move');

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const t_curr = Math.min(elapsed / 1000, measuredTime);

            const a_vis = (2 * distPx) / (measuredTime * measuredTime);
            const x_curr = 0.5 * a_vis * t_curr * t_curr;

            setCartPosition(x_curr);
            ui.timer.innerText = t_curr.toFixed(3);

            if (elapsed < duration) {
                animFrame = requestAnimationFrame(animate);
            } else {
                finishRun();
            }
        }
        animFrame = requestAnimationFrame(animate);
    }

    function finishRun() {
        isRunning = false;
        ui.btnStart.disabled = false;
        ui.btnRecord.disabled = false;
        
        const distPx = S * PIXELS_PER_METER;
        setCartPosition(distPx);
        ui.timer.innerText = measuredTime.toFixed(3);
        updateStateText('stat_finish');
    }

    function resetSim() {
        if(animFrame) cancelAnimationFrame(animFrame);
        isRunning = false;
        ui.btnStart.disabled = false;
        updateSetup();
    }

    function recordData() {
        ui.btnRecord.disabled = true;
        
        const tbody = ui.tableBody;
        const row = document.createElement('tr');
        const num = tbody.children.length + 1;
        
        const diff = Math.abs(a_theor - a_exp);
        const err = (diff / a_theor) * 100;

        row.innerHTML = `
            <td>${num}</td>
            <td>${MassCart}</td>
            <td>${MassLoad}</td>
            <td>${S.toFixed(2)}</td>
            <td>${measuredTime.toFixed(3)}</td>
            <td>${a_exp.toFixed(2)}</td>
            <td>${a_theor.toFixed(2)}</td>
            <td>${err.toFixed(1)}%</td>
        `;
        tbody.appendChild(row);

        const wrapper = document.querySelector('.table-wrap');
        wrapper.scrollTop = wrapper.scrollHeight;

        const t2 = measuredTime * measuredTime;
        chartSt.data.datasets[0].data.push({x: t2, y: S});
        
        const maxT2 = Math.max(...chartSt.data.datasets[0].data.map(p => p.x)) || t2;
        chartSt.data.datasets[1].data = [
            {x: 0, y: 0},
            {x: maxT2 * 1.1, y: 0.5 * a_theor * (maxT2 * 1.1)}
        ];
        
        chartSt.update();
        updateStateText('stat_rec');
    }

    function clearTable() {
        ui.tableBody.innerHTML = '';
        chartSt.data.datasets[0].data = [];
        chartSt.data.datasets[1].data = [];
        chartSt.update();
        updateStateText('stat_init');
    }

    initRuler();
    updateSetup();

</script>
</body>
</html>